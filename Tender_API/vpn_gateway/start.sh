#!/bin/bash

# –§–∏–∫—Å–∏–º ovpn-—Ñ–∞–π–ª—ã
/app/fix_ovpn.sh

# –ü–µ—Ä–µ–±–æ—Ä –≤—Å–µ—Ö .ovpn –∫–æ–Ω—Ñ–∏–≥–æ–≤
for CONFIG in /etc/openvpn/vpngate_*.ovpn; do
  echo "üîå –ü—Ä–æ–±—É–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫: $CONFIG"

  # –ó–∞–ø—É—Å–∫ OpenVPN –∏ –æ–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  openvpn --config "$CONFIG" &
  PID=$!

  # –î–∞—ë–º 20 —Å–µ–∫—É–Ω–¥ –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  sleep 20

  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–∫–ª—é—á—ë–Ω –ª–∏ tun0
  if ip a | grep -q "tun0"; then
    echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ: $CONFIG"
    wait $PID  # –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è openvpn
    exit 0
  else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ $CONFIG, –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π..."
    kill $PID
    sleep 2
  fi
done

echo "üõë –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∏ —á–µ—Ä–µ–∑ –æ–¥–∏–Ω .ovpn –∫–æ–Ω—Ñ–∏–≥"
exit 1
